[gd_resource type="Compositor" load_steps=3 format=3 uid="uid://r76ikc2vw5qd"]

[ext_resource type="Script" uid="uid://bqxthc3qbnr0n" path="res://Scripts/PostProcessing/PS1OverlayShader.gd" id="1_n8lbn"]

[sub_resource type="CompositorEffect" id="CompositorEffect_qqebx"]
resource_local_to_scene = false
resource_name = ""
enabled = true
effect_callback_type = 4
needs_motion_vectors = false
needs_normal_roughness = false
script = ExtResource("1_n8lbn")
shader_code = "// Determine the size of each pixel block      
// Larger values yield stronger pixelation
const int pixel_size = 4;
const ivec2 pixel_step = ivec2(pixel_size, pixel_size);
const float dither_gamma = 10;


ivec2 base_uv = (uv / pixel_step) * pixel_step;

int ps1_dither_matrix[16] = {
	    -4, 0, -3, 1,
	    2, -2, 3, -1,
	    -3, 1, -4, 0,
	    3, -1, 2, -2
};
color = imageLoad(color_image, base_uv);
ivec2 base_block = ivec2(floor(uv / pixel_step));
int idx = (base_block.x % 4) + (base_block.y % 4) * pixel_size;
float noise = float(ps1_dither_matrix[idx]);

vec3 c = color.rgb; 
c = pow(c, vec3(1.0 / dither_gamma));
c = round(c * 255.0 + noise);
c = clamp(c, vec3(0.0), vec3(255.0));
c = clamp(c / 8.0, vec3(0.0), vec3(31.0));
c /= 31.0;

c = pow(c, vec3(dither_gamma));
float p = 0;
color = vec4(c.r, c.g, c.b, 1)+vec4(p,p,p,0);




"
metadata/_custom_type_script = "uid://bqxthc3qbnr0n"

[resource]
compositor_effects = Array[CompositorEffect]([SubResource("CompositorEffect_qqebx")])
